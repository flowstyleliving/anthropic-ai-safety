================================================================================
Threshold Calibration
================================================================================

Loading model: mlx-community/Phi-3-mini-4k-instruct-4bit...
Fetching 9 files:   0%|          | 0/9 [00:00<?, ?it/s]Fetching 9 files: 100%|██████████| 9/9 [00:00<00:00, 19826.02it/s]
✓ Model loaded

Creating adapter...
✓ Adapter created: 32 layers

Loading training data from ./data/halueval/splits/train.json...
Loaded 4998 samples from ./data/halueval/splits/train.json
Sampled 200 examples for calibration (seed=42)

================================================================================
Joint (ℏₛ + PRI) Calibration
================================================================================


================================================================================
Pass 1: Precomputing Scores (200 samples)
================================================================================

Generating:   0%|          | 0/200 [00:00<?, ?it/s]Generating:   0%|          | 1/200 [01:00<3:21:57, 60.89s/it]Generating:   1%|          | 2/200 [02:12<3:41:30, 67.12s/it]Generating:   2%|▏         | 3/200 [02:15<2:04:21, 37.88s/it]Generating:   2%|▏         | 4/200 [02:19<1:20:37, 24.68s/it]Generating:   2%|▎         | 5/200 [02:29<1:02:18, 19.17s/it]Generating:   3%|▎         | 6/200 [02:32<44:16, 13.69s/it]  Generating:   4%|▎         | 7/200 [02:35<33:14, 10.33s/it]Generating:   4%|▍         | 8/200 [03:19<1:06:41, 20.84s/it]Generating:   4%|▍         | 9/200 [04:15<1:41:23, 31.85s/it]Generating:   5%|▌         | 10/200 [04:23<1:18:07, 24.67s/it]Generating:   6%|▌         | 11/200 [04:30<1:00:05, 19.08s/it]Generating:   6%|▌         | 12/200 [04:33<44:46, 14.29s/it]  Generating:   6%|▋         | 13/200 [04:36<33:57, 10.90s/it]Generating:   7%|▋         | 14/200 [05:17<1:02:07, 20.04s/it]Generating:   8%|▊         | 15/200 [05:25<50:40, 16.43s/it]  Generating:   8%|▊         | 16/200 [05:32<41:10, 13.43s/it]Generating:   8%|▊         | 17/200 [05:36<32:20, 10.61s/it]Generating:   9%|▉         | 18/200 [05:39<25:19,  8.35s/it]Generating:  10%|▉         | 19/200 [08:14<2:38:12, 52.45s/it]Generating:  10%|█         | 20/200 [08:18<1:53:44, 37.91s/it]Generating:  10%|█         | 21/200 [08:39<1:38:11, 32.92s/it]Generating:  11%|█         | 22/200 [08:54<1:21:42, 27.54s/it]Generating:  12%|█▏        | 23/200 [08:59<1:01:10, 20.74s/it]Generating:  12%|█▏        | 24/200 [09:07<49:45, 16.96s/it]  Generating:  12%|█▎        | 25/200 [09:12<38:24, 13.17s/it]Generating:  13%|█▎        | 26/200 [09:16<30:17, 10.45s/it]Generating:  14%|█▎        | 27/200 [11:15<2:04:22, 43.14s/it]Generating:  14%|█▍        | 28/200 [11:26<1:35:34, 33.34s/it]Generating:  14%|█▍        | 29/200 [11:36<1:15:41, 26.56s/it]Generating:  15%|█▌        | 30/200 [11:40<55:44, 19.68s/it]  Generating:  16%|█▌        | 31/200 [11:48<45:08, 16.03s/it]Generating:  16%|█▌        | 32/200 [11:59<41:22, 14.78s/it]Generating:  16%|█▋        | 33/200 [12:03<31:38, 11.37s/it]Generating:  17%|█▋        | 34/200 [13:01<1:10:36, 25.52s/it]Generating:  18%|█▊        | 35/200 [13:12<57:46, 21.01s/it]  Generating:  18%|█▊        | 36/200 [13:20<46:53, 17.16s/it]Generating:  18%|█▊        | 37/200 [13:29<39:56, 14.70s/it]Generating:  19%|█▉        | 38/200 [14:03<55:16, 20.47s/it]Generating:  20%|█▉        | 39/200 [14:13<46:53, 17.47s/it]Generating:  20%|██        | 40/200 [14:17<35:03, 13.15s/it]Generating:  20%|██        | 41/200 [14:26<31:35, 11.92s/it]Generating:  21%|██        | 42/200 [14:50<41:37, 15.80s/it]Generating:  22%|██▏       | 43/200 [15:01<37:18, 14.26s/it]Generating:  22%|██▏       | 44/200 [15:07<30:12, 11.62s/it]Generating:  22%|██▎       | 45/200 [15:15<27:19, 10.58s/it]Generating:  23%|██▎       | 46/200 [15:59<52:55, 20.62s/it]Generating:  24%|██▎       | 47/200 [16:03<40:16, 15.80s/it]Generating:  24%|██▍       | 48/200 [16:08<31:25, 12.40s/it]Generating:  24%|██▍       | 49/200 [16:12<25:14, 10.03s/it]Generating:  25%|██▌       | 50/200 [16:21<24:27,  9.78s/it]Generating:  26%|██▌       | 51/200 [16:24<19:13,  7.74s/it]Generating:  26%|██▌       | 52/200 [17:09<46:33, 18.87s/it]Generating:  26%|██▋       | 53/200 [17:46<59:25, 24.25s/it]Generating:  27%|██▋       | 54/200 [18:07<56:46, 23.33s/it]Generating:  28%|██▊       | 55/200 [18:10<41:43, 17.26s/it]Generating:  28%|██▊       | 56/200 [18:22<37:05, 15.45s/it]Generating:  28%|██▊       | 57/200 [18:32<33:24, 14.02s/it]Generating:  29%|██▉       | 58/200 [18:57<40:27, 17.10s/it]Generating:  30%|██▉       | 59/200 [19:03<32:41, 13.91s/it]Generating:  30%|███       | 60/200 [19:32<43:11, 18.51s/it]Generating:  30%|███       | 61/200 [21:34<1:54:21, 49.36s/it]Generating:  31%|███       | 62/200 [24:17<3:12:14, 83.59s/it]Generating:  32%|███▏      | 63/200 [25:44<3:13:18, 84.66s/it]Generating:  32%|███▏      | 64/200 [25:53<2:20:26, 61.96s/it]Generating:  32%|███▎      | 65/200 [26:46<2:13:30, 59.34s/it]Generating:  33%|███▎      | 66/200 [26:51<1:35:39, 42.83s/it]Generating:  34%|███▎      | 67/200 [26:54<1:08:42, 31.00s/it]Generating:  34%|███▍      | 68/200 [27:39<1:17:24, 35.19s/it]Generating:  34%|███▍      | 69/200 [27:43<56:27, 25.86s/it]  Generating:  35%|███▌      | 70/200 [27:48<42:10, 19.47s/it]Generating:  36%|███▌      | 71/200 [28:05<40:17, 18.74s/it]Generating:  36%|███▌      | 72/200 [28:49<56:07, 26.31s/it]Generating:  36%|███▋      | 73/200 [29:49<1:17:24, 36.57s/it]Generating:  37%|███▋      | 74/200 [29:53<55:58, 26.66s/it]  Generating:  38%|███▊      | 75/200 [29:57<41:32, 19.94s/it]Generating:  38%|███▊      | 76/200 [30:11<37:15, 18.03s/it]Generating:  38%|███▊      | 77/200 [30:18<30:27, 14.86s/it]Generating:  39%|███▉      | 78/200 [30:28<26:54, 13.24s/it]Generating:  40%|███▉      | 79/200 [30:31<20:32, 10.18s/it]Generating:  40%|████      | 80/200 [31:26<47:30, 23.75s/it]Generating:  40%|████      | 81/200 [31:32<36:14, 18.27s/it]Generating:  41%|████      | 82/200 [31:42<31:14, 15.89s/it]Generating:  42%|████▏     | 83/200 [31:49<26:06, 13.39s/it]Generating:  42%|████▏     | 84/200 [31:58<22:58, 11.88s/it]Generating:  42%|████▎     | 85/200 [32:01<17:42,  9.24s/it]Generating:  43%|████▎     | 86/200 [32:05<14:36,  7.69s/it]Generating:  44%|████▎     | 87/200 [32:59<40:38, 21.58s/it]Generating:  44%|████▍     | 88/200 [33:05<31:23, 16.82s/it]Generating:  44%|████▍     | 89/200 [33:16<28:00, 15.14s/it]Generating:  45%|████▌     | 90/200 [34:13<50:51, 27.74s/it]Generating:  46%|████▌     | 91/200 [34:16<36:56, 20.34s/it]Generating:  46%|████▌     | 92/200 [34:41<39:19, 21.84s/it]Generating:  46%|████▋     | 93/200 [34:51<32:28, 18.21s/it]Generating:  47%|████▋     | 94/200 [34:58<25:59, 14.71s/it]Generating:  48%|████▊     | 95/200 [35:02<20:23, 11.65s/it]Generating:  48%|████▊     | 96/200 [35:06<15:55,  9.19s/it]Generating:  48%|████▊     | 97/200 [36:17<47:43, 27.80s/it]Generating:  49%|████▉     | 98/200 [36:21<35:06, 20.65s/it]Generating:  50%|████▉     | 99/200 [36:24<25:53, 15.38s/it]Generating:  50%|█████     | 100/200 [36:27<19:32, 11.73s/it]Generating:  50%|█████     | 101/200 [36:38<18:44, 11.36s/it]Generating:  51%|█████     | 102/200 [36:41<14:30,  8.88s/it]Generating:  52%|█████▏    | 103/200 [36:47<12:57,  8.02s/it]Generating:  52%|█████▏    | 104/200 [36:53<11:51,  7.41s/it]Generating:  52%|█████▎    | 105/200 [36:56<09:49,  6.20s/it]Generating:  53%|█████▎    | 106/200 [37:32<23:38, 15.09s/it]Generating:  54%|█████▎    | 107/200 [39:19<1:06:20, 42.80s/it]Generating:  54%|█████▍    | 108/200 [39:30<51:00, 33.26s/it]  Generating:  55%|█████▍    | 109/200 [39:38<38:53, 25.65s/it]Generating:  55%|█████▌    | 110/200 [39:46<30:32, 20.36s/it]Generating:  56%|█████▌    | 111/200 [39:56<25:22, 17.11s/it]Generating:  56%|█████▌    | 112/200 [41:23<56:06, 38.25s/it]Generating:  56%|█████▋    | 113/200 [41:33<43:05, 29.72s/it]Generating:  57%|█████▋    | 114/200 [41:39<32:24, 22.62s/it]Generating:  57%|█████▊    | 115/200 [41:42<23:44, 16.76s/it]Generating:  58%|█████▊    | 116/200 [41:56<22:05, 15.78s/it]Generating:  58%|█████▊    | 117/200 [42:00<16:50, 12.17s/it]Generating:  59%|█████▉    | 118/200 [42:34<25:49, 18.89s/it]Generating:  60%|█████▉    | 119/200 [43:04<29:52, 22.13s/it]Generating:  60%|██████    | 120/200 [43:17<25:43, 19.29s/it]Generating:  60%|██████    | 121/200 [44:39<50:16, 38.18s/it]Generating:  61%|██████    | 122/200 [44:46<37:39, 28.96s/it]Generating:  62%|██████▏   | 123/200 [45:33<44:01, 34.31s/it]Generating:  62%|██████▏   | 124/200 [46:46<58:03, 45.83s/it]Generating:  62%|██████▎   | 125/200 [46:57<44:14, 35.39s/it]Generating:  63%|██████▎   | 126/200 [48:45<1:10:39, 57.29s/it]Generating:  64%|██████▎   | 127/200 [48:48<49:56, 41.04s/it]  Generating:  64%|██████▍   | 128/200 [48:53<36:06, 30.10s/it]Generating:  64%|██████▍   | 129/200 [48:57<26:18, 22.23s/it]Generating:  65%|██████▌   | 130/200 [49:39<33:04, 28.35s/it]Generating:  66%|██████▌   | 131/200 [49:51<26:53, 23.39s/it]Generating:  66%|██████▌   | 132/200 [50:35<33:33, 29.60s/it]Generating:  66%|██████▋   | 133/200 [50:39<24:14, 21.70s/it]Generating:  67%|██████▋   | 134/200 [50:43<18:12, 16.56s/it]Generating:  68%|██████▊   | 135/200 [51:16<23:22, 21.58s/it]Generating:  68%|██████▊   | 136/200 [51:20<17:15, 16.17s/it]Generating:  68%|██████▊   | 137/200 [51:26<13:46, 13.12s/it]Generating:  69%|██████▉   | 138/200 [53:44<52:23, 50.70s/it]Generating:  70%|██████▉   | 139/200 [53:48<37:09, 36.55s/it]Generating:  70%|███████   | 140/200 [55:47<1:01:11, 61.20s/it]Generating:  70%|███████   | 141/200 [55:53<44:01, 44.78s/it]  Generating:  71%|███████   | 142/200 [56:01<32:38, 33.77s/it]Generating:  72%|███████▏  | 143/200 [56:12<25:26, 26.78s/it]Generating:  72%|███████▏  | 144/200 [56:25<21:14, 22.75s/it]Generating:  72%|███████▎  | 145/200 [57:18<29:04, 31.73s/it]Generating:  73%|███████▎  | 146/200 [57:27<22:24, 24.90s/it]Generating:  74%|███████▎  | 147/200 [57:30<16:14, 18.38s/it]Generating:  74%|███████▍  | 148/200 [57:49<16:15, 18.76s/it]Generating:  74%|███████▍  | 149/200 [58:00<13:47, 16.23s/it]Generating:  75%|███████▌  | 150/200 [58:04<10:30, 12.61s/it]Generating:  76%|███████▌  | 151/200 [58:16<10:07, 12.41s/it]Generating:  76%|███████▌  | 152/200 [58:30<10:22, 12.96s/it]Generating:  76%|███████▋  | 153/200 [58:39<09:13, 11.77s/it]Generating:  77%|███████▋  | 154/200 [58:44<07:28,  9.76s/it]Generating:  78%|███████▊  | 155/200 [58:47<05:48,  7.75s/it]Generating:  78%|███████▊  | 156/200 [58:50<04:39,  6.34s/it]Generating:  78%|███████▊  | 157/200 [58:53<03:51,  5.39s/it]Generating:  79%|███████▉  | 158/200 [59:03<04:43,  6.74s/it]Generating:  80%|███████▉  | 159/200 [59:07<03:53,  5.70s/it]Generating:  80%|████████  | 160/200 [59:11<03:28,  5.21s/it]Generating:  80%|████████  | 161/200 [59:21<04:26,  6.84s/it]Generating:  81%|████████  | 162/200 [1:00:08<11:59, 18.93s/it]Generating:  82%|████████▏ | 163/200 [1:00:12<08:44, 14.18s/it]Generating:  82%|████████▏ | 164/200 [1:02:42<33:07, 55.19s/it]Generating:  82%|████████▎ | 165/200 [1:02:53<24:22, 41.78s/it]Generating:  83%|████████▎ | 166/200 [1:04:12<29:56, 52.84s/it]Generating:  84%|████████▎ | 167/200 [1:04:16<21:04, 38.31s/it]Generating:  84%|████████▍ | 168/200 [1:04:59<21:15, 39.85s/it]Generating:  84%|████████▍ | 169/200 [1:05:03<15:01, 29.07s/it]Generating:  85%|████████▌ | 170/200 [1:05:11<11:17, 22.60s/it]Generating:  86%|████████▌ | 171/200 [1:05:14<08:04, 16.72s/it]Generating:  86%|████████▌ | 172/200 [1:05:37<08:44, 18.73s/it]Generating:  86%|████████▋ | 173/200 [1:05:41<06:26, 14.32s/it]Generating:  87%|████████▋ | 174/200 [1:05:54<06:03, 13.98s/it]Generating:  88%|████████▊ | 175/200 [1:06:32<08:45, 21.01s/it]Generating:  88%|████████▊ | 176/200 [1:06:36<06:23, 15.98s/it]Generating:  88%|████████▊ | 177/200 [1:06:40<04:43, 12.30s/it]Generating:  89%|████████▉ | 178/200 [1:06:44<03:39,  9.96s/it]Generating:  90%|████████▉ | 179/200 [1:07:59<10:19, 29.52s/it]Generating:  90%|█████████ | 180/200 [1:08:06<07:33, 22.66s/it]Generating:  90%|█████████ | 181/200 [1:08:38<08:04, 25.50s/it]Generating:  91%|█████████ | 182/200 [1:08:41<05:38, 18.78s/it]Generating:  92%|█████████▏| 183/200 [1:09:44<09:00, 31.81s/it]Generating:  92%|█████████▏| 184/200 [1:09:51<06:32, 24.51s/it]Generating:  92%|█████████▎| 185/200 [1:10:01<05:00, 20.03s/it]Generating:  93%|█████████▎| 186/200 [1:11:16<08:34, 36.73s/it]Generating:  94%|█████████▎| 187/200 [1:12:46<11:23, 52.57s/it]Generating:  94%|█████████▍| 188/200 [1:12:55<07:52, 39.39s/it]Generating:  94%|█████████▍| 189/200 [1:12:58<05:13, 28.51s/it]Generating:  95%|█████████▌| 190/200 [1:13:16<04:13, 25.38s/it]Generating:  96%|█████████▌| 191/200 [1:13:19<02:48, 18.70s/it]Generating:  96%|█████████▌| 192/200 [1:13:23<01:54, 14.28s/it]Generating:  96%|█████████▋| 193/200 [1:14:26<03:22, 28.91s/it]Generating:  97%|█████████▋| 194/200 [1:14:32<02:12, 22.09s/it]Generating:  98%|█████████▊| 195/200 [1:14:36<01:23, 16.78s/it]Generating:  98%|█████████▊| 196/200 [1:14:41<00:52, 13.10s/it]Generating:  98%|█████████▊| 197/200 [1:14:44<00:30, 10.16s/it]Generating:  99%|█████████▉| 198/200 [1:16:16<01:09, 34.66s/it]Generating: 100%|█████████▉| 199/200 [1:17:27<00:45, 45.46s/it]Generating: 100%|██████████| 200/200 [1:17:31<00:00, 32.99s/it]Generating: 100%|██████████| 200/200 [1:17:31<00:00, 23.26s/it]
  [50/200] Memory cleanup
  [100/200] Memory cleanup
  [150/200] Memory cleanup
  [200/200] Memory cleanup

================================================================================
Score Statistics by Label
================================================================================

ℏₛ (Semantic Uncertainty):
  Hallucinated (label=1): mean=1.814, std=0.334, n=103
  Correct (label=0):      mean=1.834, std=0.279, n=97
  Mean difference: -0.021
  Effect size (Cohen's d): -0.067

PRI (Predictive Rupture Index):
  Hallucinated (label=1): mean=1.164, std=0.262
  Correct (label=0):      mean=1.208, std=0.365
  Mean difference: -0.044
  Effect size (Cohen's d): -0.138

Signal Correlation (ℏₛ vs PRI): -0.524
  ~ Signals are moderately correlated (some overlap)

================================================================================

================================================================================
Pass 2: Joint Calibration
================================================================================

Model 1: ℏₛ alone
----------------------------------------
  AUROC: 0.5087
  Best τ: 2.4031 (classify as hallucination if ℏₛ ≤ τ)
  Precision @ Recall≥0.9: 0.5179

Model 2: PRI alone
----------------------------------------
  AUROC: 0.4917
  Best τ: 0.7739 (classify as hallucination if PRI ≥ τ)
  Precision @ Recall≥0.9: 0.5178

Model 3: Joint (ℏₛ, PRI) with 5-Fold CV
----------------------------------------
  AUROC (CV): 0.5431
  Weights: w_hbar=-0.635, w_pri=-0.779, intercept=2.139
  Precision @ Recall≥0.9: 0.5278

================================================================================
Model Comparison
================================================================================
  AUROC: ℏₛ=0.5087, PRI=0.4917, Joint=0.5431
  Best model: Joint (signals are complementary)

================================================================================
Quadrant Analysis (using calibrated thresholds)
================================================================================
  τ_hbar = 2.403 (classify as hallucination if ℏₛ ≤ τ)
  τ_pri = 0.774 (classify as hallucination if PRI ≥ τ)

Q1: ℏₛ OK, PRI OK (Low Risk)
  Count: 0 (0.0%)
  Hallucination rate: 0.000

Q2: ℏₛ flags, PRI flags (High Risk)
  Count: 192 (96.0%)
  Hallucination rate: 0.521

Q3: ℏₛ OK, PRI flags (PRI-only detection)
  Count: 5 (2.5%)
  Hallucination rate: 0.400

Q4: ℏₛ flags, PRI OK (ℏₛ-only detection)
  Count: 3 (1.5%)
  Hallucination rate: 0.333

Saved calibrated parameters to ./calibrated_params/phi3_mini_20260121_200802_n200.json

================================================================================
✓ Calibration Complete!
================================================================================

Results saved to: ./calibrated_params/phi3_mini_20260121_200802_n200.json

Key findings:
  - AUROC (ℏₛ alone):  0.5087
  - AUROC (PRI alone): 0.4917
  - AUROC (Joint):     0.5431
  - τ_hbar: 2.4031
  - τ_pri:  0.7739

